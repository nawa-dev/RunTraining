<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Running Timer</title>

<meta name="viewport" content="width=390, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="icon" type="image/png" sizes="512x512" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Run Timer">

<meta property="og:title" content="Run Timer">
<meta property="og:image" content="icon.png">
<meta property="og:type" content="website">

<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
html { touch-action: manipulation; }
body { -webkit-touch-callout: none; }

html, body {
    width: 390px;
    max-width: 390px;
    overflow-x: hidden;
}

* { box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #0f172a;
    color: white;
    margin: 0 auto;
    padding: 10px;
}

button {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    transition: transform 0.08s ease;
}

button:active {
    transform: scale(0.95);
}

.time {
    font-size: 56px;
    text-align: center;
    margin: 10px 0;
    font-weight: bold;
}

.row {
    display: flex;
    gap: 8px;
}

.btn {
    width: 100%;
    padding: 16px;
    margin: 6px 0;
    font-size: 20px;
    border-radius: 12px;
    color: #ffffff;
    border: none;

    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.start { background: #22c55e; }
.stop  { background: #ef4444; }
.reset { background: #64748b; }

.lap-circle {
    width: 160px;
    height: 160px;
    border-radius: 50%;
    border: none;
    background: #3b82f6;
    color: white;
    font-size: 26px;
    margin: 16px auto;

    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.lap-item {
    background: #1e293b;
    padding: 12px;
    border-radius: 10px;
    margin: 6px 0;
    font-size: 16px;

    display: flex;
    justify-content: space-between;
    align-items: center;
}

.lap-pace {
    font-size: 26px;
    font-weight: bold;
    color: #38bdf8;
    text-align: right;
}

input {
    width: 100%;
    padding: 12px;
    font-size: 18px;
    border-radius: 10px;
    border: none;
    margin-bottom: 8px;
}
</style>
</head>

<body>

<h2><i class="fa-solid fa-person-running"></i> Timer ซ้อมวิ่ง</h2>

<input id="distance" placeholder="ระยะทางต่อรอบ (เมตร) เช่น 400">

<div class="time" id="display">00:00.00</div>

<div class="row">
    <button class="btn stop" onclick="stop()">
        <i class="fa-solid fa-pause"></i> หยุด
    </button>

    <button class="btn reset" onclick="resetAll()">
        <i class="fa-solid fa-rotate"></i> รีเซ็ต
    </button>

    <button class="btn start" onclick="start()">
        <i class="fa-solid fa-play"></i> เริ่ม
    </button>
</div>

<button class="lap-circle" onclick="lap()">
    <i class="fa-solid fa-stopwatch"></i> นับรอบ
</button>

<h3>รอบที่วิ่ง</h3>
<div id="laps"></div>

<script>
let startTime = 0;
let elapsed = 0;
let timer;
let running = false;
let lastLapTime = 0;
let lapCount = 0;
let lapsData = [];

let lastPress = 0;

// ==== EFFECT ปุ่มยุบ ====
function addPressEffect(el) {
    el.addEventListener("touchstart", () => {
        el.style.transform = "scale(0.95)";
    }, { passive: true });

    el.addEventListener("touchend", () => {
        el.style.transform = "scale(1)";
    });

    el.addEventListener("touchcancel", () => {
        el.style.transform = "scale(1)";
    });

    el.addEventListener("mousedown", () => {
        el.style.transform = "scale(0.95)";
    });

    el.addEventListener("mouseup", () => {
        el.style.transform = "scale(1)";
    });
}

document.querySelectorAll("button").forEach(addPressEffect);

// ==== กันกดซ้ำ ====
function canPress() {
    const now = Date.now();
    if (now - lastPress < 400) return false;
    lastPress = now;
    return true;
}

// ==== SAVE / LOAD ====
function save() {
    const data = {
        elapsed,
        lastLapTime,
        lapCount,
        lapsData,
        distance: distance.value,
        running
    };
    localStorage.setItem("runTimer", JSON.stringify(data));
}

function load() {
    const txt = localStorage.getItem("runTimer");
    if (!txt) return;

    try {
        const d = JSON.parse(txt);

        elapsed = d.elapsed || 0;
        lastLapTime = d.lastLapTime || 0;
        lapCount = d.lapCount || 0;
        lapsData = d.lapsData || [];
        distance.value = d.distance || "";

        renderLaps();
        display.innerText = format(elapsed);

        if (d.running) {
            running = true;
            startTime = Date.now() - elapsed;
            timer = setInterval(update, 30);
        }

    } catch(e) {}
}

// ==== FORMAT TIME ====
function format(t) {
    let ms = Math.floor((t % 1000) / 10);
    let s = Math.floor(t / 1000) % 60;
    let m = Math.floor(t / 60000);

    return (
        String(m).padStart(2,'0') + ":" +
        String(s).padStart(2,'0') + "." +
        String(ms).padStart(2,'0')
    );
}

// ==== VIBRATE ====
function vibrate() {
    if ("vibrate" in navigator) navigator.vibrate(40);
}

// ==== CALC PACE /km ====
function calcPace(timeMs, meter) {
    if (!meter || meter <= 0) return "-";

    const km = meter / 1000;
    let sec = timeMs / 1000;
    let paceSec = sec / km;

    let m = Math.floor(paceSec / 60);
    let s = Math.floor(paceSec % 60);

    return m + ":" + String(s).padStart(2,'0');
}

// ==== TIMER ====
function update() {
    elapsed = Date.now() - startTime;
    display.innerText = format(elapsed);
    save();
}

function start() {
    if (!canPress() || running) return;

    running = true;
    startTime = Date.now() - elapsed;
    timer = setInterval(update, 30);
    save();
}

function stop() {
    if (!canPress()) return;

    running = false;
    clearInterval(timer);
    save();
}

// ==== LAP ====
function lap() {
    if (!canPress()) return;

    vibrate();

    let distMeter = parseFloat(distance.value);
    let lapTime = elapsed - lastLapTime;

    lastLapTime = elapsed;
    lapCount++;

    let pace = calcPace(lapTime, distMeter);

    const item = {
        no: lapCount,
        lapTime,
        total: elapsed,
        pace
    };

    lapsData.unshift(item);

    renderLaps();
    save();
}

// ==== RENDER ====
function renderLaps() {
    laps.innerHTML = lapsData.map(i => `
        <div class="lap-item">
            <div>
                <b>รอบที่ ${i.no}</b><br>
                <i class="fa-solid fa-stopwatch"></i> ${format(i.lapTime)}<br>
                <i class="fa-solid fa-clock"></i> ${format(i.total)}
            </div>

            <div class="lap-pace">
                <i class="fa-solid fa-bolt"></i> ${i.pace}<br>
                <span style="font-size:14px">/km</span>
            </div>
        </div>
    `).join("");
}

// ==== RESET ====
function resetAll() {
    if (!canPress()) return;
    if (!confirm("ล้างข้อมูลทั้งหมด?")) return;

    clearInterval(timer);

    startTime = 0;
    elapsed = 0;
    running = false;
    lastLapTime = 0;
    lapCount = 0;
    lapsData = [];

    display.innerText = "00:00.00";
    laps.innerHTML = "";

    localStorage.removeItem("runTimer");
}

load();
window.addEventListener("beforeunload", save);
</script>

</body>
</html>
